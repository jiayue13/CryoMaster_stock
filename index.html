<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryoMaster Stock View</title>
    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --primary: #1967D2; --text: #202124; --border: #cbd5e1; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .no-select { user-select: none; -webkit-user-select: none; }

        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid var(--border); }
        .header h1 { margin: 0; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .header .meta { font-size: 0.85rem; color: #5f6368; margin-top: 4px; }
        .stat-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        .section-title { font-size: 0.95rem; font-weight: 800; color: #475569; margin: 24px 0 10px 4px; text-transform: uppercase; letter-spacing: 0.5px; border-left: 5px solid var(--primary); padding-left: 10px; }

        /* === 1. ä¸Šæ–¹ï¼šè¿·ä½ å¯¼èˆªç½‘æ ¼ (å¸¦åæ ‡è½´) === */
        .grid-wrap { overflow-x: auto; padding-bottom: 10px; }
        
        .mini-grid { 
            display: grid; 
            gap: 2px; 
            margin: 0 auto; 
            width: fit-content; 
            /* å±…ä¸­æ˜¾ç¤º */
        }
        
        /* åæ ‡è½´æ–‡å­—æ ·å¼ */
        .axis-cell {
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; color: #64748b; font-weight: bold; 
            font-family: monospace;
            width: 28px; height: 28px; /* ä¸æ ¼å­ç­‰å¤§ */
        }

        /* å®é™…æ•°æ®æ ¼å­ */
        .mini-cell { 
            width: 28px; height: 28px; 
            border-radius: 3px; 
            border: 1px solid #cbd5e1; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; color: white; cursor: pointer;
        }
        
        /* ç©ºä½æ ·å¼ï¼šæ¢å¤ä¸ºè™šçº¿æ¡† */
        .mini-cell.empty { 
            background: #f8fafc; 
            border: 1px dashed #cbd5e1; 
            color: transparent; 
        }

        /* === 2. ä¸‹æ–¹ï¼šè¯¦ç»†ä¿¡æ¯å¤§ç½‘æ ¼ === */
        .detail-scroll-container { 
            overflow: auto; 
            padding-bottom: 20px; 
            cursor: grab; 
            scrollbar-width: thin; 
        }
        .detail-scroll-container:active { cursor: grabbing; }

        #list-grid {
            display: grid;
            gap: 10px;
            width: max-content; 
            margin: 0 auto;
            padding: 2px;
        }

        .grid-card {
            background: var(--card);
            border: 1px solid #cbd5e1; 
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 170px;  
            min-height: 140px; 
            height: 100%;      
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            box-sizing: border-box;
        }
        
        .grid-card.empty-slot {
            background: #f8fafc;
            border: 2px dashed #94a3b8; 
            justify-content: flex-start;
            box-shadow: none;
            opacity: 1.0;
        }

        .grid-card.highlight { 
            border: 2px solid var(--primary); 
            background-color: #eff6ff; 
            transform: scale(1.05); 
            z-index: 10; 
            box-shadow: 0 8px 20px rgba(25, 103, 210, 0.25);
            transition: transform 0.2s;
        }

        .gc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .gc-coord { background: #dbeafe; color: #1e40af; font-family: monospace; font-size: 0.85rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        .gc-name { 
            font-weight: 700; font-size: 0.95rem; color: #0f172a; 
            word-break: break-word; 
            line-height: 1.3;
            margin-bottom: 6px;
        }
        
        .gc-body { flex-grow: 1; display: flex; flex-direction: column; gap: 6px; font-size: 0.75rem; color: #475569; }
        .gc-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; font-weight: 600; }
        .tag-type { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .tag-res { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .gc-desc {
            white-space: normal; 
            word-break: break-all;
            color: #334155;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 4px;
        }
        .gc-footer { border-top: 1px solid #e2e8f0; padding-top: 6px; margin-top: 8px; font-size: 0.7rem; color: #64748b; display: flex; justify-content: space-between; align-items: center; }

        .type-DNA { background-color: #1967D2; }
        .type-Bacteria { background-color: #F29900; }
        .type-Cell { background-color: #188038; }
        .type-Other { background-color: #5F6368; }
        
        #loading { text-align: center; padding: 40px; color: #666; }
        .error { color: #D93025; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <div id="error-msg" class="error" style="display:none;"></div>

    <div id="app" style="display:none;">
        <div class="card header">
            <h1 id="box-name">ğŸ“¦ Box</h1>
            <div class="meta"><span id="box-size"></span> â€¢ <span id="box-usage"></span></div>
            <div class="stat-bar"><div class="stat-fill" id="stat-fill"></div></div>
        </div>

        <div class="section-title">Overview</div>
        <div class="card grid-wrap">
            <div class="mini-grid" id="mini-grid"></div>
        </div>

        <div class="section-title">Detailed Grid (æŒ‰ä½æ‹–æ‹½ / å·¦å³æ»‘åŠ¨)</div>
        
        <div class="detail-scroll-container no-select" id="scroll-container">
            <div id="list-grid"></div>
        </div>
    </div>
</div>

<script>
    const COLORS = { "DNA": "#1967D2", "RNA": "#A50E0E", "Protein": "#E37400", "Cell": "#188038", "Bacteria": "#F29900", "Other": "#5F6368" };

    function parseData() {
        try {
            const hash = window.location.hash;
            if (!hash || hash.length < 2) throw new Error("No data in Hash");
            const rawData = hash.substring(1);
            let base64 = rawData.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) base64 += '=';
            const jsonStr = decodeURIComponent(Array.prototype.map.call(atob(base64), function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            renderApp(JSON.parse(jsonStr));
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerHTML = "âŒ Error: " + e.message;
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºåæ ‡è½´å•å…ƒæ ¼
    function createAxisCell(text) {
        const div = document.createElement('div');
        div.className = 'axis-cell';
        div.innerText = text;
        return div;
    }

    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        document.getElementById('box-name').innerText = "ğŸ“¦ " + data.n;
        const [rows, cols] = data.s.split('x').map(Number);
        const used = data.d.length;
        const percent = Math.round((used / (rows*cols)) * 100);
        document.getElementById('box-size').innerText = `Size: ${data.s}`;
        document.getElementById('box-usage').innerText = `Used: ${used}/${rows*cols} (${percent}%)`;
        document.getElementById('stat-fill').style.width = percent + "%";

        const wellMap = {};
        data.d.forEach(item => wellMap[`${item[0]},${item[1]}`] = item);

        // === 1. æ¸²æŸ“ä¸Šæ–¹è¿·ä½ ç½‘æ ¼ (å¸¦åæ ‡è½´) ===
        const miniGrid = document.getElementById('mini-grid');
        
        // [æ ¸å¿ƒé€»è¾‘] Grid åˆ—æ•° = 1(Row Label) + cols(Data)
        // ç¬¬ä¸€åˆ—å®½ 25pxï¼Œå…¶ä½™åˆ—å®½ 30px
        miniGrid.style.gridTemplateColumns = `25px repeat(${cols}, 30px)`;

        // --- ç¬¬ä¸€è¡Œï¼šè¡¨å¤´ (ç©º + 1, 2, 3...) ---
        miniGrid.appendChild(createAxisCell("")); // å·¦ä¸Šè§’ç©ºä½
        for (let c = 0; c < cols; c++) {
            miniGrid.appendChild(createAxisCell(c + 1));
        }

        // === 2. æ¸²æŸ“ä¸‹æ–¹è¯¦ç»†ç½‘æ ¼å®¹å™¨ ===
        const listGrid = document.getElementById('list-grid');
        listGrid.style.gridTemplateColumns = `repeat(${cols}, 170px)`; 

        // --- å¾ªç¯æ¯ä¸€è¡Œ ---
        for (let r = 0; r < rows; r++) {
            // [A] æ·»åŠ è¡Œåæ ‡è½´ (A, B, C...)
            miniGrid.appendChild(createAxisCell(String.fromCharCode(65 + r)));

            // [B] å¾ªç¯è¯¥è¡Œçš„æ¯ä¸€åˆ—
            for (let c = 0; c < cols; c++) {
                const key = `${r},${c}`;
                const coord = String.fromCharCode(65+r) + (c+1);
                
                const mCell = document.createElement('div');
                const dCard = document.createElement('div');
                dCard.id = `card-${key}`;

                if (wellMap[key]) {
                    const d = wellMap[key];
                    
                    // è¿·ä½ æ ¼å­ (Filled)
                    mCell.className = 'mini-cell';
                    mCell.style.backgroundColor = COLORS[d[3]] || COLORS['Other'];
                    // æ¢å¤æ˜¾ç¤ºé¦–å­—æ¯ (å¦‚æœä¸éœ€è¦ï¼ŒæŠŠè¿™è¡Œåˆ æ‰å³å¯)
                    mCell.innerText = d[2].substring(0, 1).toUpperCase(); 
                    if(d[4] !== 0) mCell.style.opacity = "0.5";

                    // è¯¦ç»†å¡ç‰‡
                    dCard.className = 'grid-card';
                    let statusMark = "";
                    if(d[4]===1) statusMark = "<span style='color:#b45309; font-weight:bold; font-size:0.7rem'>OUT</span>";
                    if(d[4]===2) statusMark = "<span style='color:#64748b; font-weight:bold; font-size:0.7rem'>DEL</span>";

                    dCard.innerHTML = `
                        <div class="gc-header">
                            <span class="gc-coord">${coord}</span>
                            ${statusMark}
                        </div>
                        <div class="gc-name" title="${d[2]}">${d[2]}</div>
                        
                        <div class="gc-body">
                            <div class="gc-tags">
                                <span class="tag tag-type">${d[3]}</span>
                                ${d[6] ? `<span class="tag tag-res">${d[6]}</span>` : ''}
                            </div>
                            ${d[5] ? `<div class="gc-desc">ğŸ“ ${d[5]}</div>` : ''}
                            ${d[9] ? `<div class="gc-desc" style="font-style:italic; color:#64748b;">â„¹ï¸ ${d[9]}</div>` : ''}
                        </div>
                        
                        <div class="gc-footer">
                            ${d[7] ? `<span>ğŸ‘¤ ${d[7]}</span>` : '<span></span>'}
                            ${d[8] ? `<span>${d[8].substring(5)}</span>` : ''} 
                        </div>
                    `;

                    mCell.onclick = () => {
                        dCard.scrollIntoView({behavior:"smooth", block:"nearest", inline:"center"});
                        dCard.classList.add('highlight');
                        setTimeout(() => dCard.classList.remove('highlight'), 2000);
                    };

                } else {
                    // è¿·ä½ æ ¼å­ (Empty) - ä¸æ˜¾ç¤ºæ–‡å­—ï¼Œåªç•™è™šçº¿
                    mCell.className = 'mini-cell empty';
                    
                    // è¯¦ç»†å¡ç‰‡ (Empty)
                    dCard.className = 'grid-card empty-slot';
                    dCard.innerHTML = `
                        <div class="gc-header" style="width:100%">
                            <span class="gc-coord" style="background:transparent; color:#94a3b8; border:1px solid #cbd5e1;">${coord}</span>
                        </div>
                    `;
                }

                miniGrid.appendChild(mCell);
                listGrid.appendChild(dCard);
            }
        }
        
        initDragScroll();
    }

    function initDragScroll() {
        const slider = document.getElementById('scroll-container');
        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener('mousedown', (e) => {
            isDown = true;
            slider.classList.add('active');
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => isDown = false);
        slider.addEventListener('mouseup', () => isDown = false);
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2;
            slider.scrollLeft = scrollLeft - walk;
        });
    }

    parseData();
</script>
</body>
</html>
