<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryoMaster View</title>
    <style>
        :root {
            --primary: #007AFF; --bg: #F2F2F7; --card: #FFFFFF;
            --text-main: #1D1D1F; --text-sub: #86868B; --border: #E5E5EA;
            --danger: #FF3B30; --warning: #FF9500; --success: #34C759;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 20px 16px;
            font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .header {
            background: var(--card); padding: 20px; border-radius: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); text-align: center; margin-bottom: 20px;
        }
        h1 { margin: 0 0 6px 0; font-size: 22px; font-weight: 700; }
        .meta { color: var(--text-sub); font-size: 13px; display: flex; justify-content: center; gap: 10px; }
        
        /* æœç´¢æ¡† */
        .search-wrap { margin-top: 16px; position: relative; }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: none; background: #F2F2F7; border-radius: 12px;
            font-size: 16px; color: var(--text-main); outline: none;
            transition: background 0.2s;
        }
        .search-input:focus { background: #E5E5EA; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; }

        /* ç½‘æ ¼åŒºåŸŸ */
        .grid-container {
            display: flex; justify-content: center; overflow-x: auto;
            padding-bottom: 40px; /* åº•éƒ¨ç•™ç™½ */
        }
        .grid { display: grid; gap: 6px; }
        
        .cell {
            width: 42px; height: 42px;
            border-radius: 10px; /* åœ†è§’çŸ©å½¢é£æ ¼ */
            background-color: #E5E5EA;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700; color: #fff;
            position: relative; cursor: pointer;
            transition: transform 0.1s, opacity 0.2s, filter 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .cell:active { transform: scale(0.9); }
        .cell.empty { background: transparent; border: 1px dashed #C7C7CC; color: transparent; pointer-events: none; box-shadow: none; }
        
        /* æœç´¢çŠ¶æ€æ ·å¼ */
        .cell.dimmed { opacity: 0.1; filter: grayscale(100%); }
        .cell.highlight { z-index: 2; transform: scale(1.1); box-shadow: 0 0 0 2px #007AFF; }

        /* çŠ¶æ€å°åœ†ç‚¹ */
        .status-dot {
            position: absolute; top: -3px; right: -3px;
            width: 9px; height: 9px; border-radius: 50%;
            border: 2px solid var(--bg);
        }
        .s-removed { background: var(--warning); }
        .s-discarded { background: var(--text-sub); }

        /* åº•éƒ¨å¼¹çª— (Modal) */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-mask.show { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.1);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 101;
        }
        .modal-mask.show .modal-card { transform: translateY(0); }

        /* å¼¹çª—å†…å®¹ */
        .m-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .m-coord { 
            background: var(--primary); color: #fff; padding: 4px 10px; 
            border-radius: 8px; font-weight: 800; font-size: 14px;
        }
        .m-close { font-size: 24px; color: #C7C7CC; background: none; border: none; padding: 0; }
        
        .m-title { font-size: 20px; font-weight: 700; margin: 0 0 4px 0; }
        .m-sub { color: var(--text-sub); font-size: 14px; font-weight: 500; margin-bottom: 20px; }
        
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .info-label { color: var(--text-sub); }
        .info-val { font-weight: 600; text-align: right; }
        
        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; }
        .tag { 
            background: #F2F2F7; color: var(--text-main); 
            padding: 4px 10px; border-radius: 6px; 
            font-size: 12px; font-weight: 600; 
        }
        
        .desc-box { 
            margin-top: 16px; padding: 12px; background: #F9F9F9; 
            border-radius: 12px; font-size: 13px; color: #666; line-height: 1.5; 
        }
        .warn-text { color: var(--danger); font-weight: bold; }

        /* åŠ è½½åŠ¨ç”» */
        .loading { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-sub); font-weight: 500; text-align: center;
        }
    </style>
</head>
<body>

<div id="loading" class="loading">æ­£åœ¨è§£ææ•°æ®...</div>

<div id="app" style="display: none;">
    <div class="header">
        <h1 id="bName">Loading...</h1>
        <div class="meta">
            <span id="bSize">-</span>
            <span>â€¢</span>
            <span id="bCount">0 æ ·æœ¬</span>
        </div>
        <div class="search-wrap">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="search" class="search-input" placeholder="æœç´¢åç§°ã€å¤‡æ³¨ã€ç±»å‹...">
        </div>
    </div>

    <div class="grid-container">
        <div id="grid" class="grid"></div>
    </div>
</div>

<div class="modal-mask" id="modalMask" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="m-header">
            <div id="mCoord" class="m-coord">A1</div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <h2 id="mName" class="m-title">Sample Name</h2>
        <div id="mType" class="m-sub">Type | Feature</div>
        
        <div class="info-row">
            <span class="info-label">çŠ¶æ€</span>
            <span class="info-val" id="mStatus">In Stock</span>
        </div>
        <div class="info-row">
            <span class="info-label">ä½“ç§¯</span>
            <span class="info-val" id="mVol">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">æ—¥æœŸ/æ“ä½œäºº</span>
            <span class="info-val" id="mOpDate">-</span>
        </div>
        
        <div id="mTags" class="tags"></div>
        <div id="mDesc" class="desc-box" style="display:none;"></div>
    </div>
</div>

<script>
    // é¢œè‰²é…ç½® (å¯¹åº” Python config.py)
    const COLORS = {
        "DNA": "#1967D2", "RNA": "#A50E0E", "Protein": "#E37400",
        "Cell": "#188038", "Bacteria": "#F29900", "Other": "#5F6368"
    };
    
    // æœç´¢ç¼“å­˜
    let searchCache = [];

    window.onload = function() {
        try {
            // 1. ä» URL Hash ä¸­è·å–æ•°æ®
            const hash = window.location.hash.substring(1);
            if (!hash) throw new Error("æ— æ•°æ®é“¾æ¥");
            
            // 2. Base64 è§£ç 
            const jsonStr = decodeURIComponent(escape(window.atob(hash)));
            const data = JSON.parse(jsonStr);
            
            renderApp(data);
        } catch (e) {
            document.getElementById('loading').innerHTML = "æ— æ•ˆçš„é“¾æ¥æˆ–æ•°æ®æŸå<br><small>è¯·é‡æ–°ç”ŸæˆäºŒç»´ç </small>";
        }
    };

    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // å¡«å……å¤´éƒ¨
        document.getElementById('bName').textContent = data.n;
        document.getElementById('bSize').textContent = data.s;
        document.getElementById('bCount').textContent = `${data.d.length} æ ·æœ¬`;

        // æ¸²æŸ“ç½‘æ ¼
        const [rows, cols] = data.s.split('x').map(Number);
        const grid = document.getElementById('grid');
        grid.style.gridTemplateColumns = `repeat(${cols}, 42px)`;

        // æ•°æ®æ˜ å°„ Map
        const map = new Map();
        data.d.forEach(item => map.set(`${item[0]},${item[1]}`, item));

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const el = document.createElement('div');
                const key = `${r},${c}`;
                const item = map.get(key);
                // åæ ‡è½¬æ¢ (0,0 -> A1)
                const coord = String.fromCharCode(65 + r) + (c + 1);

                if (item) {
                    // è§£æ„æ•°æ® (12é¡¹)
                    const [row, col, name, type, st, feat, res, op, date, desc, vol, maxVol] = item;
                    
                    el.className = 'cell';
                    el.style.backgroundColor = COLORS[type] || COLORS['Other'];
                    el.textContent = name.substring(0, 3); // ç®€å†™
                    
                    // çŠ¶æ€ç‚¹
                    if (st === 1) el.innerHTML += '<div class="status-dot s-removed"></div>'; // å–å‡º
                    if (st === 2) el.innerHTML += '<div class="status-dot s-discarded"></div>'; // æŠ¥åºŸ
                    
                    // ç»‘å®šç‚¹å‡»
                    el.onclick = () => showModal(item, coord);
                    
                    // åŠ å…¥æœç´¢ç¼“å­˜
                    searchCache.push({
                        el: el,
                        txt: (name + ' ' + type + ' ' + feat + ' ' + res + ' ' + desc).toLowerCase()
                    });
                } else {
                    el.className = 'cell empty';
                }
                grid.appendChild(el);
            }
        }
        
        // ç»‘å®šæœç´¢äº‹ä»¶
        document.getElementById('search').addEventListener('input', (e) => {
            const key = e.target.value.toLowerCase().trim();
            searchCache.forEach(obj => {
                if (!key) {
                    obj.el.classList.remove('dimmed', 'highlight');
                } else {
                    if (obj.txt.includes(key)) {
                        obj.el.classList.add('highlight');
                        obj.el.classList.remove('dimmed');
                    } else {
                        obj.el.classList.add('dimmed');
                        obj.el.classList.remove('highlight');
                    }
                }
            });
        });
    }

    function showModal(item, coord) {
        const [row, col, name, type, st, feat, res, op, date, desc, vol, maxVol] = item;
        
        document.getElementById('mCoord').textContent = coord;
        document.getElementById('mCoord').style.backgroundColor = COLORS[type] || '#888';
        
        document.getElementById('mName').textContent = name;
        document.getElementById('mType').textContent = type + (feat ? ` | ${feat}` : '');
        
        const sts = ["åœ¨åº“ (In Stock)", "å·²å–å‡º (Removed)", "å·²æŠ¥åºŸ (Discarded)"];
        const stEl = document.getElementById('mStatus');
        stEl.textContent = sts[st];
        stEl.style.color = st === 0 ? '#34C759' : (st === 1 ? '#FF9500' : '#8E8E93');
        
        document.getElementById('mOpDate').textContent = `${date} (${op || '-'})`;
        
        // ä½“ç§¯æ˜¾ç¤º + é¢„è­¦
        const volEl = document.getElementById('mVol');
        if (maxVol > 0) {
            const pct = Math.round((vol / maxVol) * 100);
            volEl.textContent = `${vol} / ${maxVol} Î¼L (${pct}%)`;
            if (pct < 30 && st === 0) volEl.className = "info-val warn-text";
            else volEl.className = "info-val";
        } else {
            volEl.textContent = "-";
            volEl.className = "info-val";
        }
        
        // æŠ—æ€§æ ‡ç­¾
        const tagBox = document.getElementById('mTags');
        tagBox.innerHTML = '';
        if (res) {
            res.split(',').forEach(tag => {
                if(tag.trim()) tagBox.innerHTML += `<span class="tag">ğŸ’Š ${tag}</span>`;
            });
        }
        
        // å¤‡æ³¨
        const dBox = document.getElementById('mDesc');
        if (desc) {
            dBox.style.display = 'block';
            dBox.textContent = desc;
        } else {
            dBox.style.display = 'none';
        }

        document.getElementById('modalMask').classList.add('show');
    }

    function closeModal() {
        document.getElementById('modalMask').classList.remove('show');
    }
</script>

</body>
</html>
