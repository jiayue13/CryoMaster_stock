<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryoMaster Stock View</title>
    <style>
        :root { --bg: #f5f7fa; --card: #ffffff; --primary: #1967D2; --text: #202124; --border: #dadce0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 12px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* é¡¶éƒ¨ç›’å­ä¿¡æ¯å¡ç‰‡ */
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .header h1 { margin: 0; font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .header .meta { font-size: 0.85rem; color: #5f6368; margin-top: 4px; }
        .stat-bar { height: 4px; background: #f1f3f4; border-radius: 2px; margin-top: 12px; overflow: hidden; }
        .stat-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        /* === 1. å¯è§†åŒ–ç½‘æ ¼å›¾æ ·å¼ === */
        .grid-wrap { overflow-x: auto; padding-bottom: 5px; }
        .grid { display: grid; gap: 3px; margin: 0 auto; width: fit-content; }
        .cell { 
            width: 32px; height: 32px; border-radius: 4px; border: 1px solid #eee; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; color: white; cursor: pointer;
        }
        .cell.empty { background: #f9f9f9; border: 1px dashed #ccc; color: transparent; }
        
        .section-title { font-size: 0.9rem; font-weight: 700; color: #5f6368; margin: 20px 0 8px 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === 2. è¯¦ç»†åˆ—è¡¨å¡ç‰‡æ ·å¼ === */
        .list-item { 
            background: var(--card);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            gap: 8px; /* å†…éƒ¨é—´è· */
        }
        
        /* å¡ç‰‡ç¬¬ä¸€è¡Œï¼šåæ ‡ + åç§° */
        .row-top { display: flex; align-items: center; gap: 8px; }
        .coord-badge { 
            font-family: monospace; font-weight: 700; font-size: 1rem; 
            color: var(--primary); background: #e8f0fe; 
            padding: 2px 8px; border-radius: 4px; 
        }
        .sample-name { font-weight: 700; font-size: 1.1rem; color: #202124; }
        
        /* å¡ç‰‡ç¬¬äºŒè¡Œï¼šèƒ¶å›Šæ ‡ç­¾ (ç±»å‹ã€æŠ—æ€§) */
        .row-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .pill { 
            display: flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 12px; 
            font-size: 0.8rem; font-weight: 500; border: 1px solid transparent;
        }
        .pill-type { background: #e3f2fd; color: #174ea6; border-color: #d2e3fc; }
        .pill-res { background: #fce8e6; color: #c5221f; border-color: #fad2cf; }
        .icon-mini { width: 14px; height: 14px; fill: currentColor; }

        /* å¡ç‰‡ç¬¬ä¸‰è¡Œï¼šæè¿°æ–‡æœ¬ (ç‰¹å¾ã€å¤‡æ³¨) */
        .row-text { font-size: 0.85rem; color: #3c4043; display: flex; flex-direction: column; gap: 2px; }
        .text-line { display: flex; align-items: flex-start; gap: 6px; }

        /* å¡ç‰‡åº•éƒ¨ï¼šå…ƒæ•°æ® (æ—¥æœŸã€äººå‘˜) */
        .row-meta { 
            font-size: 0.75rem; color: #70757a; 
            margin-top: 4px; padding-top: 8px; 
            border-top: 1px solid #f1f3f4;
            display: flex; align-items: center; gap: 12px;
        }

        /* çŠ¶æ€æ ‡è®° */
        .status-badge { margin-left: auto; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .st-out { background: #fef7e0; color: #b06000; border: 1px solid #fce8b2; }
        .st-del { background: #f1f3f4; color: #5f6368; border: 1px solid #dadce0; }

        /* é¢œè‰²å®šä¹‰ */
        .type-DNA { background-color: #1967D2; }
        .type-RNA { background-color: #A50E0E; }
        .type-Protein { background-color: #E37400; }
        .type-Bacteria { background-color: #F29900; }
        .type-Cell { background-color: #188038; }
        .type-Other { background-color: #5F6368; }
        .status-OUT { background-color: #E37400 !important; opacity: 0.6; }
        .status-DEL { background-color: #5F6368 !important; opacity: 0.3; }

        #loading { text-align: center; padding: 40px; color: #666; }
        .error { color: #D93025; text-align: center; padding: 20px; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <div id="error-msg" class="error" style="display:none;"></div>

    <div id="app" style="display:none;">
        <div class="card header">
            <h1 id="box-name">ğŸ“¦ Unknown Box</h1>
            <div class="meta">
                <span id="box-size"></span> &nbsp;â€¢&nbsp; <span id="box-usage"></span>
            </div>
            <div class="stat-bar"><div class="stat-fill" id="stat-fill"></div></div>
        </div>

        <div class="section-title">Visual Map</div>
        <div class="card grid-wrap">
            <div class="grid" id="grid-container"></div>
            <div style="margin-top:10px; font-size:0.75rem; color:#666; display:flex; gap:10px;">
                <span style="display:flex;align-items:center"><span style="width:8px;height:8px;background:#1967D2;border-radius:50%;margin-right:4px;"></span>DNA</span>
                <span style="display:flex;align-items:center"><span style="width:8px;height:8px;background:#F29900;border-radius:50%;margin-right:4px;"></span>Bact</span>
                <span style="display:flex;align-items:center"><span style="width:8px;height:8px;background:#188038;border-radius:50%;margin-right:4px;"></span>Cell</span>
            </div>
        </div>

        <div class="section-title">Detailed List</div>
        <div id="list-container"></div>
    </div>
</div>

<script>
    const COLORS = { "DNA": "#1967D2", "RNA": "#A50E0E", "Protein": "#E37400", "Cell": "#188038", "Bacteria": "#F29900", "Other": "#5F6368" };

    function parseData() {
        try {
            const hash = window.location.hash;
            if (!hash || hash.length < 2) throw new Error("No data in Hash (#)");
            const rawData = hash.substring(1);
            let base64 = rawData.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) base64 += '=';
            const jsonStr = decodeURIComponent(Array.prototype.map.call(atob(base64), function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            renderApp(JSON.parse(jsonStr));
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerHTML = "âŒ æ•°æ®åŠ è½½å¤±è´¥<br><small>" + e.message + "</small>";
        }
    }

    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        // === åŸºç¡€ä¿¡æ¯ ===
        document.getElementById('box-name').innerText = "ğŸ“¦ " + data.n;
        const [rows, cols] = data.s.split('x').map(Number);
        const used = data.d.length;
        const percent = Math.round((used / (rows*cols)) * 100);

        document.getElementById('box-size').innerText = `ID: ${data.s}`; 
        document.getElementById('box-usage').innerText = `å·²ç”¨: ${used}/${rows*cols} (${percent}%)`;
        document.getElementById('stat-fill').style.width = percent + "%";

        // === æ¸²æŸ“ç½‘æ ¼å›¾ ===
        const wellMap = {};
        data.d.forEach(item => wellMap[`${item[0]},${item[1]}`] = item);
        const grid = document.getElementById('grid-container');
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                const key = `${r},${c}`;
                if (wellMap[key]) {
                    const d = wellMap[key];
                    cell.className = 'cell';
                    if (d[4] === 1) cell.classList.add('status-OUT');
                    if (d[4] === 2) cell.classList.add('status-DEL');
                    cell.style.backgroundColor = COLORS[d[3]] || COLORS['Other'];
                    cell.innerText = d[2].substring(0, 2);
                    // ç‚¹å‡»ç½‘æ ¼è·³è½¬åˆ°ä¸‹æ–¹åˆ—è¡¨
                    cell.onclick = () => {
                        const el = document.getElementById(`item-${key}`);
                        if(el) {
                            el.scrollIntoView({behavior:"smooth", block:"center"});
                            el.style.backgroundColor = "#fff8e1";
                            setTimeout(() => el.style.backgroundColor = "white", 1500);
                        }
                    };
                } else {
                    cell.className = 'cell empty';
                }
                grid.appendChild(cell);
            }
        }

        // === æ¸²æŸ“è¯¦ç»†åˆ—è¡¨ (å¡ç‰‡å¼) ===
        const list = document.getElementById('list-container');
        
        // æ ¸å¿ƒæ’åºï¼šæŒ‰ A1, A2... B1... é¡ºåº
        data.d.sort((a,b) => (a[0] - b[0]) || (a[1] - b[1]));
        
        data.d.forEach(item => {
            // 0:r, 1:c, 2:name, 3:type, 4:status, 5:feat, 6:res, 7:op, 8:date, 9:desc
            const [r, c, name, type, status, feat, res, op, date, desc] = item;
            const coord = String.fromCharCode(65+r) + (c+1); // A1, A2...
            
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `item-${r},${c}`;

            // çŠ¶æ€
            let statusBadge = "";
            if (status === 1) statusBadge = `<span class="status-badge st-out">OUT</span>`;
            if (status === 2) statusBadge = `<span class="status-badge st-del">DEL</span>`;

            // SVG å›¾æ ‡
            const iconDna = `<svg class="icon-mini" viewBox="0 0 24 24"><path d="M4.5 9.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5zm15 0a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z"/></svg>`;
            const iconRes = `<svg class="icon-mini" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`;

            div.innerHTML = `
                <div class="row-top">
                    <span class="coord-badge">${coord}</span>
                    <span class="sample-name">${name}</span>
                    ${statusBadge}
                </div>

                <div class="row-tags">
                    <span class="pill pill-type">${iconDna} ${type}</span>
                    ${res ? `<span class="pill pill-res">${iconRes} ${res}</span>` : ""}
                </div>

                ${(feat || desc) ? `
                <div class="row-text">
                    ${feat ? `<div class="text-line"><span style="font-size:0.8rem">ğŸ“</span><span>${feat}</span></div>` : ""}
                    ${desc ? `<div class="text-line"><span style="font-size:0.8rem">â„¹ï¸</span><span style="font-style:italic;color:#666">${desc}</span></div>` : ""}
                </div>` : ""}

                <div class="row-meta">
                    ${op ? `<span>ğŸ‘¤ ${op}</span>` : ""}
                    ${date ? `<span>ğŸ“… ${date}</span>` : ""}
                </div>
            `;
            list.appendChild(div);
        });
    }

    parseData();
</script>
</body>
</html>
