<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryoMaster Stock</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text-main: #000000;
            --text-sub: #8E8E93;
            --separator: #C6C6C8;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px 16px;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* === é¡¶éƒ¨å¡ç‰‡ === */
        .header-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            text-align: center;
        }

        h1 { margin: 0 0 8px 0; font-size: 22px; font-weight: 700; }
        .meta { color: var(--text-sub); font-size: 13px; display: flex; justify-content: center; gap: 12px; }
        
        /* æœç´¢æ¡† */
        .search-box {
            margin-top: 16px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border-radius: 10px;
            border: none;
            background: #E3E3E8;
            font-size: 16px;
            color: var(--text-main);
            transition: all 0.3s;
        }
        .search-input:focus { background: #D1D1D6; outline: none; }
        .search-icon {
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
            color: var(--text-sub); font-size: 14px;
        }

        /* === ç½‘æ ¼å®¹å™¨ === */
        .grid-container {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding-bottom: 40px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
        }

        .grid {
            display: grid;
            gap: 8px;
            padding: 10px;
        }

        /* === ç»†èƒæ ¼æ ·å¼ === */
        .cell {
            width: 40px;
            height: 40px;
            border-radius: 10px; /* æ–¹åœ†å½¢æ›´ç°ä»£ */
            background-color: #E5E5EA;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.3s, filter 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .cell:active { transform: scale(0.9); }
        .cell.empty { background-color: #E5E5EA; box-shadow: none; border: 1px dashed #C7C7CC; }
        .cell.dimmed { opacity: 0.1; filter: grayscale(100%); } /* æœç´¢æœªåŒ¹é…çŠ¶æ€ */

        /* çŠ¶æ€æ ‡è®° */
        .status-dot {
            position: absolute; top: -2px; right: -2px;
            width: 8px; height: 8px; border-radius: 50%;
            border: 2px solid var(--bg);
        }
        .s-removed { background: var(--warning); }
        .s-discarded { background: var(--text-sub); }

        /* === å¼¹çª— (Modal) === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-card {
            background: var(--card);
            width: 90%; max-width: 360px;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .close-btn {
            position: absolute; top: 16px; right: 16px;
            background: #F2F2F7; border: none;
            width: 30px; height: 30px; border-radius: 50%;
            font-size: 18px; color: #8E8E93;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* å¼¹çª—å†…å®¹ */
        .m-coord {
            display: inline-block;
            background: var(--primary); color: white;
            padding: 4px 10px; border-radius: 8px;
            font-size: 12px; font-weight: bold; margin-bottom: 12px;
        }
        .m-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; line-height: 1.3; }
        .m-type { font-size: 14px; color: var(--text-sub); font-weight: 600; margin-bottom: 16px; display: block; }
        
        .info-row {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid #F2F2F7;
            font-size: 14px;
        }
        .info-row:last-child { border-bottom: none; }
        .label { color: var(--text-sub); }
        .value { font-weight: 500; text-align: right; }

        .tags-container { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }
        .tag {
            background: #E5E5EA; color: var(--text-main);
            padding: 4px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 500;
        }

        .desc-box {
            margin-top: 16px; padding: 12px;
            background: #F9F9F9; border-radius: 12px;
            font-size: 13px; color: #666; line-height: 1.5;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex; justify-content: center; align-items: center; height: 80vh;
            color: var(--text-sub); font-weight: 500;
        }
    </style>
</head>
<body>

<div id="loading" class="loading">æ­£åœ¨è§£ç æ•°æ®...</div>

<div id="app" style="display: none;">
    <div class="header-card">
        <h1 id="boxName">Box Name</h1>
        <div class="meta">
            <span id="boxSize">9x9</span>
            <span>â€¢</span>
            <span id="boxCount">0 items</span>
        </div>
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢åç§°ã€å¤‡æ³¨ã€ç±»å‹...">
        </div>
    </div>

    <div class="grid-container">
        <div id="grid" class="grid"></div>
    </div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        
        <div class="m-coord" id="mCoord">A1</div>
        <div class="m-title" id="mName">Sample Name</div>
        <span class="m-type" id="mType">Type</span>

        <div class="info-row">
            <span class="label">çŠ¶æ€</span>
            <span class="value" id="mStatus">In Stock</span>
        </div>
        <div class="info-row">
            <span class="label">æ“ä½œäºº</span>
            <span class="value" id="mOp">-</span>
        </div>
        <div class="info-row">
            <span class="label">æ—¥æœŸ</span>
            <span class="value" id="mDate">-</span>
        </div>
        
        <div class="tags-container" id="mTags"></div>
        
        <div class="desc-box" id="mDesc" style="display:none;"></div>
    </div>
</div>

<script>
    // é¢œè‰²é…ç½® (ä¸ Python config.py ä¿æŒä¸€è‡´)
    const COLORS = {
        "DNA": "#1967D2", "RNA": "#A50E0E", "Protein": "#E37400",
        "Cell": "#188038", "Bacteria": "#F29900", "Other": "#5F6368",
        "Default": "#8E8E93"
    };

    let allCellsData = []; // å­˜å‚¨æ‰€æœ‰æ ¼å­æ•°æ®ç”¨äºæœç´¢

    window.onload = function() {
        try {
            const hash = window.location.hash.substring(1);
            if (!hash) throw new Error("No Data");
            
            // Base64 è§£ç 
            const jsonStr = decodeURIComponent(escape(window.atob(hash)));
            const data = JSON.parse(jsonStr);
            
            renderApp(data);
        } catch (e) {
            document.getElementById('loading').innerHTML = "æ— æ³•åŠ è½½æ•°æ®<br><small>é“¾æ¥å¯èƒ½å·²æŸå</small>";
        }
    };

    function renderApp(payload) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        // 1. å¡«å……å¤´éƒ¨ä¿¡æ¯
        document.getElementById('boxName').textContent = payload.n;
        document.getElementById('boxSize').textContent = payload.s;
        document.getElementById('boxCount').textContent = `${payload.d.length} ä¸ªæ ·æœ¬`;

        // 2. å‡†å¤‡ç½‘æ ¼
        const [rows, cols] = payload.s.split('x').map(Number);
        const grid = document.getElementById('grid');
        grid.style.gridTemplateColumns = `repeat(${cols}, 40px)`; // å›ºå®šåˆ—å®½

        // 3. æ„å»ºæ•°æ® Map
        const dataMap = new Map();
        payload.d.forEach(item => dataMap.set(`${item[0]},${item[1]}`, item));

        // 4. ç”Ÿæˆç½‘æ ¼
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                const coordKey = `${r},${c}`;
                const item = dataMap.get(coordKey);
                
                // åæ ‡ (0,0 -> A1)
                const coordLabel = String.fromCharCode(65 + r) + (c + 1);

                if (item) {
                    const [row, col, name, type, stCode, feature, res, op, date, desc] = item;
                    
                    cell.className = 'cell filled';
                    cell.style.backgroundColor = COLORS[type] || COLORS['Other'];
                    cell.textContent = name.substring(0, 3); // ç®€å†™æ˜¾ç¤º
                    
                    // çŠ¶æ€çº¢ç‚¹
                    if (stCode === 1 || stCode === 2) {
                        const dot = document.createElement('div');
                        dot.className = `status-dot ${stCode === 1 ? 's-removed' : 's-discarded'}`;
                        cell.appendChild(dot);
                    }

                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    cell.onclick = () => openModal(item, coordLabel);
                    
                    // å­˜å…¥æœç´¢æ± 
                    allCellsData.push({
                        element: cell,
                        text: `${name} ${type} ${res} ${op} ${desc} ${coordLabel}`.toLowerCase()
                    });
                } else {
                    cell.className = 'cell empty';
                    // ç©ºæ ¼å­ä¹Ÿå­˜å…¥ï¼Œä½†ä¸å¯æœç´¢åˆ°å†…å®¹
                    allCellsData.push({ element: cell, text: "___EMPTY___" });
                }

                grid.appendChild(cell);
            }
        }

        // 5. ç»‘å®šæœç´¢äº‹ä»¶
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
    }

    function handleSearch(query) {
        const term = query.trim().toLowerCase();
        
        allCellsData.forEach(item => {
            if (!term) {
                // æ¸…ç©ºæ—¶æ¢å¤
                item.element.classList.remove('dimmed');
            } else {
                // åŒ¹é…é€»è¾‘
                if (item.text.includes(term)) {
                    item.element.classList.remove('dimmed');
                } else {
                    item.element.classList.add('dimmed');
                }
            }
        });
    }

    function openModal(item, coord) {
        const [row, col, name, type, stCode, feature, res, op, date, desc] = item;
        
        // å¡«å……æ•°æ®
        document.getElementById('mCoord').textContent = coord;
        document.getElementById('mCoord').style.backgroundColor = COLORS[type] || COLORS['Other'];
        
        document.getElementById('mName').textContent = name;
        document.getElementById('mType').textContent = type;
        
        const statusMap = ["åœ¨åº“ (In Stock)", "å·²å–å‡º (Removed)", "å·²æŠ¥åºŸ (Discarded)"];
        const stEl = document.getElementById('mStatus');
        stEl.textContent = statusMap[stCode] || "Unknown";
        stEl.style.color = stCode === 0 ? '#34C759' : (stCode === 1 ? '#FF9500' : '#8E8E93');

        document.getElementById('mOp').textContent = op || '-';
        document.getElementById('mDate').textContent = date || '-';

        // æŠ—æ€§æ ‡ç­¾
        const tagsContainer = document.getElementById('mTags');
        tagsContainer.innerHTML = '';
        if (res) {
            res.split(',').forEach(tag => {
                if (tag.trim()) {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.textContent = tag.trim();
                    tagsContainer.appendChild(span);
                }
            });
        }
        
        // ç‰¹å¾
        if (feature) {
             const span = document.createElement('span');
             span.className = 'tag';
             span.style.background = '#E3F2FD';
             span.style.color = '#1967D2';
             span.textContent = "ğŸ§¬ " + feature;
             tagsContainer.appendChild(span);
        }

        // å¤‡æ³¨
        const descBox = document.getElementById('mDesc');
        if (desc) {
            descBox.style.display = 'block';
            descBox.textContent = desc;
        } else {
            descBox.style.display = 'none';
        }

        // æ˜¾ç¤ºåŠ¨ç”»
        document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }
</script>

</body>
</html>
